<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin - KK Homestay</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="style.css">
<style>
body { background: url('static/images/mount-kinabalu.jpg') no-repeat center center fixed; background-size: cover; color: #333; }
section { background: rgba(255,255,255,0.95); padding: 20px; margin: 20px auto; border-radius: 10px; max-width: 1000px; }
.homestay-card { display:flex; flex-direction:column; background:white; padding:15px; border-radius:8px; margin-top:15px; box-shadow:0 0 5px rgba(0,0,0,0.1); }
.homestay-card img { width:150px; height:100px; object-fit:cover; margin:5px; border-radius:6px; }
.image-preview { display:flex; flex-wrap:wrap; gap:5px; margin-top:5px; }
button { cursor:pointer; margin-top:5px; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
th, td { padding:8px; border:1px solid #ccc; text-align:left; }
th { background:#007bff; color:white; }
</style>
</head>
<body>

<section>
<h2>Admin Login</h2>
<form id="admin-login-form">
  <label>Username</label><input type="text" id="admin-username" required>
  <label>Password</label><input type="password" id="admin-password" required>
  <button type="submit">Login</button>
  <p id="status"></p>
</form>

<div id="admin-section" style="display:none;">
<h2>Manage Homestays</h2>
<form id="admin-form" enctype="multipart/form-data">
  <input type="hidden" id="homestay_id">
  <label>Name</label><input type="text" id="name" required>
  <label>Location</label><input type="text" id="location" required>
  <label>Price</label><input type="number" id="price" step="0.01" required>
  <label>Description</label><textarea id="description" required></textarea>
  <label>Upload Images</label><input type="file" id="images" multiple>
  <div class="image-preview" id="image-preview"></div>
  <button type="submit">Save Homestay</button>
</form>

<h3>Existing Homestays</h3>
<div id="homestay-list"></div>

<h3>Bookings</h3>
<div id="booking-list"></div>

<h3>Users</h3>
<button id="export-users">Export Users CSV</button>
</div>
</section>

<script>
const API_BASE="https://kk-homestay-backend.onrender.com";

// Admin Login
document.getElementById("admin-login-form").addEventListener("submit", async e=>{
  e.preventDefault();
  const username=document.getElementById("admin-username").value;
  const password=document.getElementById("admin-password").value;
  try{
    const res=await fetch(`${API_BASE}/admin-login`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({username,password})
    });
    const data=await res.json();
    document.getElementById("status").textContent=data.message;
    document.getElementById("admin-section").style.display="block";
    document.getElementById("admin-login-form").style.display="none";
    loadHomestays(); loadBookings();
  }catch(err){document.getElementById("status").textContent="Login failed";}
});

// Load Homestays
async function loadHomestays(){
  const res=await fetch(`${API_BASE}/homestays`);
  const data=await res.json();
  const container=document.getElementById("homestay-list");
  container.innerHTML="";
  data.forEach(h=>{
    const div=document.createElement("div");
    div.className="homestay-card";
    div.innerHTML=`
      <h4>${h.name}</h4>
      <div class="image-preview">${h.images.map(i=>`<img src="${i}">`).join('')}</div>
      <p>${h.location} â€” RM ${h.price}</p>
      <p>${h.description}</p>
      <button onclick="editHomestay(${h.id})">Edit</button>
      <button onclick="deleteHomestay(${h.id})">Delete</button>
    `;
    container.appendChild(div);
  });
}

// Load Bookings
async function loadBookings(){
  const res=await fetch(`${API_BASE}/bookings`);
  const data=await res.json();
  const container=document.getElementById("booking-list");
  if(!data.length){ container.innerHTML="<p>No bookings yet.</p>"; return; }
  let html="<table><tr><th>User</th><th>Homestay</th><th>Date</th><th>Paid</th></tr>";
  data.forEach(b=>{ html+=`<tr><td>${b.user}</td><td>${b.homestay}</td><td>${b.date}</td><td>${b.paid?'Yes':'No'}</td></tr>`; });
  html+="</table>";
  container.innerHTML=html;
}

// Export Users
document.getElementById("export-users").addEventListener("click", async ()=>{
  const res=await fetch(`${API_BASE}/users`);
  const users=await res.json();
  const csv='ID,Username\n'+users.map(u=>`${u.id},${u.username}`).join('\n');
  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='users.csv'; a.click();
});

// Image Preview
document.getElementById("images").addEventListener("change", e=>{
  const files=e.target.files;
  const preview=document.getElementById("image-preview");
  preview.innerHTML="";
  Array.from(files).forEach(f=>{
    const img=document.createElement("img");
    img.src=URL.createObjectURL(f);
    img.style.width="100px"; img.style.height="80px"; img.style.objectFit="cover"; img.style.margin="3px";
    preview.appendChild(img);
  });
});

// Add/Update Homestay
document.getElementById("admin-form").addEventListener("submit", async e=>{
  e.preventDefault();
  const form=new FormData();
  const files=document.getElementById("images").files;
  for(let i=0;i<files.length;i++) form.append("images",files[i]);
  form.append("name", document.getElementById("name").value);
  form.append("location", document.getElementById("location").value);
  form.append("price", document.getElementById("price").value);
  form.append("description", document.getElementById("description").value);
  const id=document.getElementById("homestay_id").value;
  const url=id?`${API_BASE}/admin/homestays/${id}`:`${API_BASE}/admin/homestays`;
  const method=id?"PUT":"POST";
  const res=await fetch(url,{method,body:form});
  const data=await res.json();
  alert(data.message);
  document.getElementById("admin-form").reset();
  document.getElementById("homestay_id").value="";
  document.getElementById("image-preview").innerHTML="";
  loadHomestays();
});

// Edit/Delete Homestay
async function editHomestay(id){
  const res=await fetch(`${API_BASE}/homestays`);
  const data=await res.json();
  const h=data.find(x=>x.id===id);
  if(!h) return;
  document.getElementById("homestay_id").value=h.id;
  document.getElementById("name").value=h.name;
  document.getElementById("location").value=h.location;
  document.getElementById("price").value=h.price;
  document.getElementById("description").value=h.description;
  const preview=document.getElementById("image-preview");
  preview.innerHTML=h.images.map(i=>`<img src="${i}" style="width:100px;height:80px;object-fit:cover;margin:3px;">`).join('');
}
async function deleteHomestay(id){
  if(!confirm("Delete this homestay?")) return;
  await fetch(`${API_BASE}/admin/homestays/${id}`,{method:"DELETE"});
  loadHomestays();
}
</script>
</body>
</html>
