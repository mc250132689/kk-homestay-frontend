<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KK Homestay - Admin Panel</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<header>
<h1>üè° Admin Panel</h1>
<a href="index.html">Home</a>
</header>
<main>
<h2>Add / Update Homestay</h2>
<form id="admin-form">
<input type="hidden" id="homestay_id">
<label>Name: <input type="text" id="name" required></label>
<label>Location: <input type="text" id="location" required></label>
<label>Price: <input type="number" id="price" required></label>
<label>Description: <textarea id="description" rows="3" required></textarea></label>
<label>Images (comma-separated URLs): <textarea id="images" rows="2" required></textarea></label>
<button type="submit">Save Homestay</button>
</form>

<h2>Existing Homestays</h2>
<div id="homestay-list"></div>

</main>

<script>
const API_BASE = "http://127.0.0.1:8000";

async function fetchHomestays(){
    const res = await fetch(`${API_BASE}/homestays`);
    const homestays = await res.json();
    const container = document.getElementById("homestay-list");
    container.innerHTML = homestays.map(h => {
        let imgs = JSON.parse(h.images || '["https://via.placeholder.com/400x200"]');
        let carousel = `<div class="carousel">${imgs.map((img,i)=>`<img src="${img}" class="carousel-img ${i===0?'active':''}">`).join('')}
        <button class="prev">&#10094;</button><button class="next">&#10095;</button></div>`;
        return `<div class="homestay-card">
        <div>${carousel}<h3>${h.name}</h3><p>${h.description}</p>
        <p>Location: ${h.location}</p><p>Price: $${h.price}</p></div>
        <div class="card-buttons">
        <button onclick="editHomestay(${h.id})">Edit</button>
        <button onclick="deleteHomestay(${h.id})">Delete</button>
        </div>
        </div>`;
    }).join('');

    // initialize carousel swipe/auto
    document.querySelectorAll('.homestay-card').forEach(card=>{
        let index=0;
        const imgs=card.querySelectorAll('.carousel-img');
        const prev=card.querySelector('.prev');
        const next=card.querySelector('.next');
        const carouselEl=card.querySelector('.carousel');
        function showImg(i){imgs.forEach(im=>im.classList.remove('active'));imgs[i].classList.add('active');}
        prev.addEventListener('click',()=>{index=(index-1+imgs.length)%imgs.length;showImg(index);});
        next.addEventListener('click',()=>{index=(index+1)%imgs.length;showImg(index);});
        let startX=0;
        carouselEl.addEventListener('touchstart',e=>startX=e.touches[0].clientX);
        carouselEl.addEventListener('touchend',e=>{
            let endX=e.changedTouches[0].clientX;
            if(endX-startX>50){index=(index-1+imgs.length)%imgs.length;showImg(index);}
            else if(startX-endX>50){index=(index+1)%imgs.length;showImg(index);}
        });
        setInterval(()=>{index=(index+1)%imgs.length;showImg(index);},4000);
    });
}

async function saveHomestay(e){
    e.preventDefault();
    const id = document.getElementById('homestay_id').value;
    const data = new FormData();
    data.append('name', document.getElementById('name').value);
    data.append('location', document.getElementById('location').value);
    data.append('price', document.getElementById('price').value);
    data.append('description', document.getElementById('description').value);
    data.append('images', JSON.stringify(document.getElementById('images').value.split(',').map(s=>s.trim())));
    let res;
    if(id){ // update
        res = await fetch(`${API_BASE}/admin/homestays/${id}`, {method:'PUT', body:data});
    } else { // create
        res = await fetch(`${API_BASE}/admin/homestays`, {method:'POST', body:data});
    }
    const result = await res.json();
    alert(result.message);
    document.getElementById('admin-form').reset();
    document.getElementById('homestay_id').value = '';
    fetchHomestays();
}

function editHomestay(id){
    fetch(`${API_BASE}/homestays`).then(res=>res.json()).then(homestays=>{
        const h = homestays.find(x=>x.id===id);
        if(!h) return;
        document.getElementById('homestay_id').value = h.id;
        document.getElementById('name').value = h.name;
        document.getElementById('location').value = h.location;
        document.getElementById('price').value = h.price;
        document.getElementById('description').value = h.description;
        document.getElementById('images').value = JSON.parse(h.images).join(', ');
    });
}

async function deleteHomestay(id){
    if(!confirm("Are you sure you want to delete this homestay?")) return;
    const res = await fetch(`${API_BASE}/admin/homestays/${id}`, {method:'DELETE'});
    const result = await res.json();
    alert(result.message);
    fetchHomestays();
}

document.getElementById('admin-form').addEventListener('submit', saveHomestay);
fetchHomestays();
</script>
</body>
</html>
